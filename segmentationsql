WITH User_Details AS (
    SELECT 
        u.user_id,
        u.gender,
        u.married,
        u.birthdate,
        EXTRACT(YEAR FROM AGE(u.birthdate)) AS age,
        CASE 
            WHEN EXTRACT(YEAR FROM AGE(u.birthdate)) BETWEEN 13 AND 19 THEN 'Teenager'
            WHEN EXTRACT(YEAR FROM AGE(u.birthdate)) BETWEEN 20 AND 35 THEN 'Young Adult'
            WHEN EXTRACT(YEAR FROM AGE(u.birthdate)) BETWEEN 36 AND 50 THEN 'Middle-Aged'
            ELSE 'Senior'
        END AS age_group
    FROM Users u
),
Session_Data AS (
    SELECT 
        s.user_id,
        COUNT(s.session_id) AS total_sessions,
        SUM(CASE WHEN s.flight_booked = TRUE OR s.hotel_booked = TRUE THEN 1 ELSE 0 END)::float / NULLIF(COUNT(s.session_id), 0) AS booking_ratio
    FROM Sessions s
    GROUP BY s.user_id
),
Flight_Data AS (
    SELECT 
        s.user_id,
        COUNT(f.trip_id) AS total_flights
    FROM Flights f
    JOIN Sessions s ON f.trip_id = s.trip_id
    GROUP BY s.user_id
),
Hotel_Data AS (
    SELECT 
        s.user_id,
        COUNT(h.trip_id) AS total_hotels
    FROM Hotels h
    JOIN Sessions s ON h.trip_id = s.trip_id
    GROUP BY s.user_id
),
Travel_Frequency AS (
    SELECT 
        s.user_id,
        COUNT(DISTINCT s.trip_id) AS total_trips
    FROM Sessions s
    GROUP BY s.user_id
),
Promotion_Segment AS (
    SELECT 
        u.user_id,
        CASE 
            WHEN sd.booking_ratio >= 0.75 THEN 'Gold Member - 5% Discount'
            WHEN ud.age_group = 'Young Adult' AND fd.total_flights >= 3 THEN 'Free Local Flight'
            WHEN tf.total_trips > 4 AND fd.total_flights > 0 AND hd.total_hotels > 0 THEN 'Free Hotel Night'
            ELSE NULL
        END AS applied_promotion
    FROM Users u
    LEFT JOIN User_Details ud ON u.user_id = ud.user_id
    LEFT JOIN Session_Data sd ON u.user_id = sd.user_id
    LEFT JOIN Flight_Data fd ON u.user_id = fd.user_id
    LEFT JOIN Hotel_Data hd ON u.user_id = hd.user_id
    LEFT JOIN Travel_Frequency tf ON u.user_id = tf.user_id
)
SELECT 
    u.user_id,
    ud.age_group,
    sd.total_sessions,
    fd.total_flights,
    hd.total_hotels,
    tf.total_trips,
    ps.applied_promotion
FROM Users u
LEFT JOIN User_Details ud ON u.user_id = ud.user_id
LEFT JOIN Session_Data sd ON u.user_id = sd.user_id
LEFT JOIN Flight_Data fd ON u.user_id = fd.user_id
LEFT JOIN Hotel_Data hd ON u.user_id = hd.user_id
LEFT JOIN Travel_Frequency tf ON u.user_id = tf.user_id
LEFT JOIN Promotion_Segment ps ON u.user_id = ps.user_id;





